													TOPPERS Confidential
		TOPPERSプロジェクト 設計メモ
		コンフィギュレータにおける保護ドメインの扱い

		作成者: 高田広章（名古屋大学）
		最終更新: 2018年5月18日

○メモの位置付け

このメモは，TOPPERS第3世代カーネル向けコンフィギュレータにおける保護ド
メインの取扱いについて検討するものである。

○保護ドメインIDの割当て

他のオブジェクトと異なり，保護ドメインのID番号はパス1で割り当てる。これ
は，静的APIの整数定数式パラメータ（具体的にはアクセス許可パターン）の中
で，保護ドメイン名を（例えば「TACP(DOM1)」のように）参照する必要がある
ためである。

ID番号を割り当てるパス1では，保護ドメインに関する記述が条件ディレクティ
ブによって除外されるかどうか判断することができない。そのため，システム
コンフィギュレーションファイル中に記述された保護ドメインについては，条
件ディレクティブに関係なくID番号を割り付ける。そのため，ユーザドメイン
の数に対する制限（TOPPERS第3世代カーネルでは32個以下）は，条件ディレク
ティブで除外した（つもりの）ものも含めた数に対して課される。

パス1で割り当てた保護ドメインIDは，$domainIdに書き込み，cfg1_out.dbによ
りパス2に引き渡す。$domainIdは，保護ドメイン名をキーとし，保護ドメイン
ID（数値）を値とするハッシュである。

パス1では，また，静的APIの整数定数式パラメータ中で保護ドメイン名を参照
することから，cfg1_out.cの中に保護ドメインIDの定義（#define）を生成する。

パス1において，--id-input-fileオプションでID番号入力ファイル名を指定す
ることで，保護ドメインIDの割付けをファイルから取り込むことができる。

○ドメインデータ（$domData）への格納

●保護ドメインに関する情報

パス2では，パス1から渡された$domainIdの情報を，ドメインデータ
（$domData）に格納する。具体的には，$domDataは，2重のハッシュ（ハッシュ
のハッシュ）で，具体的な構造は以下の通りである。

$domDataは，ドメインIDの値をキーとし，パラメータ情報を値とするハッシュ
である。パラメータ情報としては，生成スクリプトに渡される時点では，ドメ
イン名とドメインIDの値を保持するNumStrクラスのオブジェクトを持つ:domid
のみを格納している。

$domDataの例として，DOM1とDOM2の2つのドメインの囲みが記述され，それら
にそれぞれID番号1と2が割り当てられた時，$domDataは次の内容となる。

----------------------------------------
{-1=>{:domid=>NumStr(-1,"TDOM_KERNEL")},
 -2=>{:domid=>NumStr(-2,"TDOM_NONE")},
 1=>{:domid=>NumStr(1,"DOM1")},
 2=>{:domid=>NumStr(2,"DOM2")}}
----------------------------------------

この例に示すように，$domDataには，カーネルドメイン（キーが-1）と無所属
（キーが-2）も登録される。また，保護ドメインIDの順にソートされていると
は限らない。

HRP3カーネルの生成スクリプトでは，ユーザドメインのみに対して処理を行い
たい場合が多いため，生成スクリプトで，ユーザドメインの保護ドメインIDの
リスト（配列）を，$udomainListに格納している。$udomainListは，保護ドメ
インIDの順にソートされている。

なお，$domainIdは，パス2より後には引き渡さない。

●静的APIが属する保護ドメインに関する情報

静的APIが保護ドメインの囲みの中に記述されている場合，パス2において，そ
の静的APIのパラメータ情報に，:domainをキーとして，属する保護ドメインID
（数値）を格納する。

例えば，タスクIDが1のタスクを生成する静的API（CRE_TSK）が，保護ドメイン
IDが3のドメインの囲みの中に記述されている場合，

	$cfgData[:CRE_TSK][1][:domain] == 3

となる。ここで，格納されている値は，NumStrクラスのオブジェクトではなく，
数値であることに注意すること。保護ドメイン名を文字列で取り出したい場合
には，以下のような記述が必要である。

	domain = $cfgData[:CRE_TSK][1][:domain]
	$domData[domain][:domid].str

以上
